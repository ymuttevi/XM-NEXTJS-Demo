"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const traversal_1 = require("../../traversal");
// expands link fields with 'jss://other-item-id' link values into links to those other items
exports.default = (args) => {
    const { pipelineResult: manifest } = args;
    const handleField = (field) => {
        if (field.value && field.value.href && field.value.href.startsWith('jss://')) {
            const id = field.value.href.substring(6);
            let path = '';
            traversal_1.traverseItems(manifest.items.routes, (item, currentPath) => {
                if (!item.id || item.id !== id) {
                    return;
                }
                path = currentPath;
            });
            if (!path) {
                throw new Error(`The link ${field.value.href} pointed to a nonexistant route ID.`);
            }
            // the path value is a root relative including the root, e.g. home/foo
            // for a link, we want the route path which would not include the 'home' piece so we strip it
            // for a root link, there's no / so we just sub that in
            // eslint-disable-next-line no-param-reassign
            field.value.href = path.indexOf('/') >= 0 ? path.substring(path.indexOf('/')) : '/';
        }
    };
    traversal_1.traverseAllFields(manifest.items.routes, handleField);
    traversal_1.traverseAllFields(manifest.items.nonRoutes, handleField);
    return args;
};
