"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.strip = exports.compile = void 0;
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const glob_1 = __importDefault(require("glob"));
const PATTERN = '**/*.@(js|ts?(x))';
const IGNORE_PATTERN = '@(node_modules|dist|.next|out|.generated)/**';
/**
 * Generates comments block
 * @param {string} prefix starting part
 * @param {string} [suffix] ending part
 * @returns {RegExp} regExp
 */
const getStripRegExp = (prefix, suffix = 'STRIP') => {
    const name = `#${prefix}_${suffix}`;
    return new RegExp(`(// ${name})|({\\/\\* ${name} \\*\\/})`, 'g');
};
/**
 * Remove part of code which inside the comments block
 * @param {string} file
 * @param {StripSettings} settings
 */
const compile = (file, settings) => {
    const content = fs_1.default.readFileSync(file, 'utf8');
    let shouldRemove = false;
    const lines = content.split('\r\n').filter((line) => {
        const isStartLine = getStripRegExp('START', settings.suffix).test(line);
        const isEndLine = getStripRegExp('END', settings.suffix).test(line);
        if (!settings.stripCode) {
            return !(isStartLine || isEndLine);
        }
        if (isStartLine) {
            shouldRemove = true;
        }
        if (isEndLine) {
            shouldRemove = false;
            return shouldRemove;
        }
        return !shouldRemove;
    });
    fs_1.default.writeFileSync(file, lines.join('\r\n'));
};
exports.compile = compile;
/**
 * Removes part of code which inside the special comments block.
 * Compiles each not excluded file starting from current directory (or `settings.sourcePath`).
 * @param {StripSettings} settings
 */
const strip = (settings = {}) => {
    const { pattern = PATTERN, ignore = IGNORE_PATTERN, cwd = process.cwd() } = settings;
    const files = glob_1.default.sync(pattern, { ignore, cwd });
    files.forEach((file) => exports.compile(path_1.default.resolve(cwd, file), settings));
};
exports.strip = strip;
